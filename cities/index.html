<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D City Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7b0d0d;
            --secondary-color: #dbc07c;
            --background-color: #f5f0e6;
            --text-color: #2e2218;
            --border-color: #a08c68;
            --panel-color: #f9f7f0;
            --hover-color: #e9dec8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'EB Garamond', serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--panel-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        header {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid var(--border-color);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            font-style: italic;
        }
        
        .controls {
            background-color: var(--panel-color);
            padding: 15px 20px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        select, button {
            font-family: 'EB Garamond', serif;
            font-size: 1rem;
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }
        
        button {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: #5e0a0a;
        }
        
        .content {
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .city-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .city-title {
            flex: 1;
        }
        
        .city-name {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .city-nickname {
            font-style: italic;
            font-size: 1.3rem;
            color: #5a5245;
        }
        
        .flag-container {
            width: 200px;
            height: 120px;
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .section {
            background-color: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .section-header {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            padding: 10px 15px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .section-content {
            padding: 15px;
        }
        
        h3 {
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .stat {
            padding: 8px;
            background-color: #f5f0e6;
            border-radius: 4px;
        }
        
        .stat-label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #5a5245;
        }
        
        .stat-value {
            font-size: 1.1rem;
        }
        
        ul {
            list-style-position: inside;
            margin-left: 8px;
        }
        
        li {
            margin-bottom: 4px;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            color: white;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .expanded {
            max-height: 2000px;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted var(--primary-color);
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        
        @media (max-width: 768px) {
            .city-header {
                flex-direction: column;
                align-items: center;
            }
            
            .city-title {
                text-align: center;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .filters {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>D&D City Generator</h1>
            <div class="subtitle">Create detailed fantasy cities for your campaign</div>
        </header>
        
        <div class="controls">
            <div class="filters">
                <select id="size-filter">
                    <option value="any">Any Size</option>
                    <option value="hamlet">Hamlet</option>
                    <option value="village">Village</option>
                    <option value="town">Town</option>
                    <option value="city">City</option>
                    <option value="metropolis">Metropolis</option>
                </select>
                
                <select id="government-filter">
                    <option value="any">Any Government</option>
                    <option value="monarchy">Monarchy</option>
                    <option value="republic">Republic</option>
                    <option value="oligarchy">Oligarchy</option>
                    <option value="theocracy">Theocracy</option>
                    <option value="magocracy">Magocracy</option>
                    <option value="military dictatorship">Military Dictatorship</option>
                    <option value="merchant consortium">Merchant Consortium</option>
                </select>
                
                <select id="climate-filter">
                    <option value="any">Any Climate</option>
                    <option value="temperate">Temperate</option>
                    <option value="tropical">Tropical</option>
                    <option value="arid">Arid</option>
                    <option value="arctic">Arctic</option>
                    <option value="alpine">Alpine</option>
                </select>
            </div>
            
            <button id="generate-btn">
                <span class="material-icons">auto_awesome</span>
                Generate City
            </button>
        </div>
        
        <div class="content" id="city-content">
            <div class="city-header">
                <div class="city-title">
                    <h2 class="city-name">Ravenhollow</h2>
                    <div class="city-nickname">"The Shrouded Sanctuary"</div>
                </div>
                
                <div class="flag-container" id="flag">
                    <!-- Flag will be generated here -->
                </div>
            </div>
            
            <div class="sections">
                <!-- Demographics Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="material-icons">groups</span>
                        Demographics
                    </div>
                    <div class="section-content expanded">
                        <div class="stat-grid">
                            <div class="stat">
                                <div class="stat-label">Population</div>
                                <div class="stat-value">12,547</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Growth Rate</div>
                                <div class="stat-value">+1.8%/year</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Birth Rate</div>
                                <div class="stat-value">22.4 per 1000</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Median Age</div>
                                <div class="stat-value">42 years</div>
                            </div>
                        </div>
                        
                        <h3>Racial Demographics</h3>
                        <div id="demographics-list">
                            <div>Human: 48%</div>
                            <div>Elf: 15%</div>
                            <div>Dwarf: 22%</div>
                            <div>Halfling: 10%</div>
                            <div>Other: 5%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Geography Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="material-icons">terrain</span>
                        Geography
                    </div>
                    <div class="section-content expanded">
                        <div class="stat-grid">
                            <div class="stat">
                                <div class="stat-label">Size</div>
                                <div class="stat-value">4.8 sq. miles</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Elevation</div>
                                <div class="stat-value">1,245 ft</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Climate</div>
                                <div class="stat-value">Temperate</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Terrain</div>
                                <div class="stat-value">Hilly Forest</div>
                            </div>
                        </div>
                        
                        <h3>Natural Features</h3>
                        <ul id="natural-features">
                            <li>Surrounded by dense oak and pine forests</li>
                            <li>Built atop three rolling hills</li>
                            <li>Bisected by the swift-flowing Ravenrun River</li>
                            <li>Natural limestone caves beneath the northeast district</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Government Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="material-icons">account_balance</span>
                        Government
                    </div>
                    <div class="section-content expanded">
                        <div class="stat-grid">
                            <div class="stat">
                                <div class="stat-label">Type</div>
                                <div class="stat-value">Oligarchy</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Leader</div>
                                <div class="stat-value">High Councilor</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Stability</div>
                                <div class="stat-value">Stable</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Corruption</div>
                                <div class="stat-value">Moderate</div>
                            </div>
                        </div>
                        
                        <h3>Ruling Entities</h3>
                        <div id="government-details">
                            <p>The Council of Five oversees all aspects of governance, with each member representing a major guild or faction in the city.</p>
                            <p>Current High Councilor: <strong>Maldon Ironwright</strong> (Dwarf, 149 years old)</p>
                            <p>The city guard numbers 200 well-trained individuals equipped with enchanted weapons.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Economy Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="material-icons">store</span>
                        Economy
                    </div>
                    <div class="section-content expanded">
                        <div class="stat-grid">
                            <div class="stat">
                                <div class="stat-label">Wealth</div>
                                <div class="stat-value">Prosperous</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Currency</div>
                                <div class="stat-value">Standard + Local</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Trade</div>
                                <div class="stat-value">Regional Hub</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Tax Rate</div>
                                <div class="stat-value">12% of income</div>
                            </div>
                        </div>
                        
                        <h3>Major Industries</h3>
                        <div id="industries-list">
                            <div>Silver mining (primary export)</div>
                            <div>Lumber and woodcraft</div>
                            <div>Brewing and distilling</div>
                            <div>Enchanted trinkets and minor magical items</div>
                        </div>
                    </div>
                </div>
                
                <!-- Society & Culture Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="material-icons">theater_comedy</span>
                        Society & Culture
                    </div>
                    <div class="section-content expanded">
                        <h3>Languages</h3>
                        <div id="languages-list">
                            <div>Common (official)</div>
                            <div>Dwarvish (common in trade)</div>
                            <div>Elvish (used in academic settings)</div>
                        </div>
                        
                        <h3>Education</h3>
                        <div class="stat">
                            <div class="stat-label">Literacy Rate</div>
                            <div class="stat-value">65%</div>
                        </div>
                        
                        <h3>Crime</h3>
                        <div class="stat-grid">
                            <div class="stat">
                                <div class="stat-label">Crime Rate</div>
                                <div class="stat-value">Low</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Punishment</div>
                                <div class="stat-value">Strict</div>
                            </div>
                        </div>
                        <div id="crime-details">
                            <p>The Shadowveil Guild operates a small thieves' network, but mainly targets visitors rather than residents.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Religion Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="material-icons">church</span>
                        Religion
                    </div>
                    <div class="section-content expanded">
                        <h3>Primary Faiths</h3>
                        <div id="religions-list">
                            <div>Moradin, God of Dwarves and Creation (28%)</div>
                            <div>Pelor, God of Sun and Healing (25%)</div>
                            <div>Sehanine Moonbow, Goddess of Moonlight (15%)</div>
                            <div>Various other deities (32%)</div>
                        </div>
                        
                        <h3>Holy Sites</h3>
                        <ul id="holy-sites">
                            <li>Temple of the Forge (Moradin)</li>
                            <li>Cathedral of Dawn (Pelor)</li>
                            <li>Moonlit Sanctuary (Sehanine)</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Architecture & Infrastructure Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="material-icons">domain</span>
                        Architecture
                    </div>
                    <div class="section-content expanded">
                        <div class="stat-grid">
                            <div class="stat">
                                <div class="stat-label">Walls</div>
                                <div class="stat-value">Stone, 25ft high</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Style</div>
                                <div class="stat-value">Dwarven-influenced</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Streets</div>
                                <div class="stat-value">Cobblestone</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Sewers</div>
                                <div class="stat-value">Extensive</div>
                            </div>
                        </div>
                        
                        <h3>Notable Structures</h3>
                        <ul id="notable-structures">
                            <li>The High Tower (government)</li>
                            <li>Silverbridge (spans the Ravenrun)</li>
                            <li>The Grand Market Hall</li>
                            <li>The Whispering Archive (library)</li>
                        </ul>
                        
                        <h3>Districts</h3>
                        <div id="districts-list">
                            <div>Highhill (nobility, government)</div>
                            <div>Silvergate (merchants, craftsmen)</div>
                            <div>Riveredge (docks, warehouses)</div>
                            <div>The Warrens (lower class housing)</div>
                        </div>
                    </div>
                </div>
                
                <!-- History & Lore Section -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <span class="material-icons">auto_stories</span>
                        History & Lore
                    </div>
                    <div class="section-content expanded">
                        <div class="stat-grid">
                            <div class="stat">
                                <div class="stat-label">Founded</div>
                                <div class="stat-value">342 years ago</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Founded By</div>
                                <div class="stat-value">Dwarven miners</div>
                            </div>
                        </div>
                        
                        <h3>Key Historical Events</h3>
                        <ul id="historical-events">
                            <li><strong>Year 5</strong>: Discovery of rich silver veins beneath the hills</li>
                            <li><strong>Year 78</strong>: Great Fire destroyed much of the original settlement</li>
                            <li><strong>Year 156</strong>: Repelled siege by orc warbands</li>
                            <li><strong>Year 287</strong>: Formed alliance with nearby elven forests</li>
                        </ul>
                        
                        <h3>Local Legends</h3>
                        <div id="legends">
                            <p>It's said that a silver dragon slumbers beneath the city, its presence blessing the mines with abundance.</p>
                            <p>The Whispering River is believed to carry messages from deceased loved ones on misty nights.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Arrays for City Generation
        
        // City Names
        const prefixes = ["Ravens", "Silver", "Oak", "Iron", "Shadow", "Bright", "Stone", "Dragon", "Golden", "Elm", "Frost", "Green", "River", "Winter", "Summer", "Spring", "Autumn", "Ember", "Crystal", "Cloud", "Star", "Moon", "Sun", "Storm", "Wave", "Mist", "Dawn", "Dusk", "Twilight", "Mystic"];
        
        const suffixes = ["holm", "port", "haven", "keep", "ford", "bridge", "gate", "vale", "fell", "dale", "wood", "ridge", "mount", "hall", "town", "stead", "wick", "crest", "shaw", "field", "burn", "mire", "rest", "watch", "guard", "cross", "hollow", "grove", "glen", "cliff", "peak", "spire"];
        
        // City Nicknames
        const nicknamePrefix = ["The", "City of", "Haven of", "Home of", "Realm of", "Land of"];
        const nicknameNouns = ["Spires", "Towers", "Mists", "Shadows", "Light", "Gold", "Silver", "Trade", "Knowledge", "Magic", "Steel", "Stone", "Rivers", "Hills", "Mountains", "Forests", "Coins", "Secrets", "Whispers", "Dreams", "Stars", "Fortune", "Valor", "Wisdom"];
        const nicknameAdjectives = ["Hidden", "Ancient", "Eternal", "Shining", "Gleaming", "Blessed", "Sacred", "Mystical", "Enchanted", "Mighty", "Unyielding", "Prosperous", "Noble", "Golden", "Silver", "Shadowed", "Shrouded", "Radiant", "Towering", "Arcane", "Forgotten", "Vigilant", "Emerald", "Azure", "Crimson"];
        
        // City Sizes
        const citySizes = [
            {type: "hamlet", minPop: 50, maxPop: 300, guards: "5-15"},
            {type: "village", minPop: 301, maxPop: 1000, guards: "10-30"},
            {type: "town", minPop: 1001, maxPop: 5000, guards: "30-100"},
            {type: "city", minPop: 5001, maxPop: 25000, guards: "100-500"},
            {type: "metropolis", minPop: 25001, maxPop: 100000, guards: "500-2000"}
        ];
        
        // Races
        const races = [
            {name: "Human", commonality: 35},
            {name: "Elf", commonality: 15},
            {name: "Dwarf", commonality: 15},
            {name: "Halfling", commonality: 10},
            {name: "Half-Elf", commonality: 8},
            {name: "Gnome", commonality: 5},
            {name: "Dragonborn", commonality: 3},
            {name: "Tiefling", commonality: 3},
            {name: "Half-Orc", commonality: 3},
            {name: "Goliath", commonality: 2},
            {name: "Aasimar", commonality: 1}
        ];
        
        // Governments
        const governments = [
            {
                type: "Monarchy",
                titles: ["King", "Queen", "Prince", "Princess", "Duke", "Duchess", "Baron", "Baroness"],
                stability: ["Stable", "Unstable", "Contested", "New Dynasty"],
                features: [
                    "Royal lineage dating back centuries",
                    "Recently seized the throne",
                    "Beloved by the common folk",
                    "Feared by the people",
                    "Rules with an iron fist",
                    "Benevolent ruler",
                    "Puppet of powerful advisors",
                    "Advised by a council of nobles",
                    "Religious authority supports the crown"
                ]
            },
            {
                type: "Republic",
                titles: ["Mayor", "Governor", "Chancellor", "Elected Leader", "First Citizen"],
                stability: ["Stable", "Recently Formed", "Corrupt", "Reforming"],
                features: [
                    "Elected officials serve fixed terms",
                    "Only property owners may vote",
                    "Universal adult suffrage",
                    "Council of elected representatives",
                    "Annual elections",
                    "Election by lottery",
                    "Meritocratic system",
                    "Founded after overthrowing a tyrant",
                    "Experimental democratic system"
                ]
            },
            {
                type: "Oligarchy",
                titles: ["High Councilor", "Guild Master", "Merchant Lord", "Chancellor", "Director"],
                stability: ["Stable", "Fractious", "Competitive", "Collaborating"],
                features: [
                    "Rule by the wealthiest families",
                    "Merchant guilds control politics",
                    "Council of Five makes all decisions",
                    "Shadowy cabal of power brokers",
                    "Merchant princes vie for influence",
                    "Military officers hold key positions",
                    "Wealthy foreign investors maintain control",
                    "Ancient families control all resources",
                    "Rival factions in constant power struggle"
                ]
            },
            {
                type: "Theocracy",
                titles: ["High Priest", "Divine Speaker", "Oracle", "Chosen One", "Prophet"],
                stability: ["Devout", "Zealous", "Tolerant", "Reforming"],
                features: [
                    "Single faith dominates all aspects of life",
                    "Religious council interprets divine will",
                    "Laws based on sacred texts",
                    "Religious festivals dictate the calendar",
                    "Different faiths must pay special taxes",
                    "Non-believers face restrictions",
                    "Religious police enforce moral codes",
                    "City built around massive temple complex",
                    "Claim direct communication with deity"
                ]
            },
            {
                type: "Magocracy",
                titles: ["Archmage", "Grand Conjurer", "Master of Elements", "Spellweaver", "Arcanist"],
                stability: ["Mysterious", "Powerful", "Secretive", "Enlightened"],
                features: [
                    "Only magic users may hold office",
                    "Districts divided by magical schools",
                    "Magical ability determines social rank",
                    "Heavy regulation of magical items",
                    "Magical research is the city's focus",
                    "Apprenticeship system for governance",
                    "Magical constructs handle menial labor",
                    "Wards and enchantments throughout the city",
                    "Floating towers for the magical elite"
                ]
            },
            {
                type: "Military Dictatorship",
                titles: ["General", "Commander", "Warlord", "Field Marshal", "Strategos"],
                stability: ["Iron-fisted", "Disciplined", "Oppressive", "Protective"],
                features: [
                    "Martial law is permanent",
                    "City built around defensive needs",
                    "Mandatory military service",
                    "Heavy fortifications",
                    "Strict curfews enforced",
                    "Military patrols at all hours",
                    "Civilian activities tightly regulated",
                    "War economy",
                    "Constant drills and preparations for conflict"
                ]
            },
            {
                type: "Merchant Consortium",
                titles: ["Trade Prince", "Merchant Lord", "Chief Factor", "Guild Leader", "Market Master"],
                stability: ["Prosperous", "Competitive", "Cutthroat", "Booming"],
                features: [
                    "Everything has a price",
                    "Laws favor commercial interests",
                    "Tax incentives for new businesses",
                    "Complex system of contracts and debts",
                    "Guild halls more impressive than government buildings",
                    "Foreign quarter for international traders",
                    "Deals sealed with magical contracts",
                    "Mercantile families control politics",
                    "Regular trade fairs attract visitors from afar"
                ]
            }
        ];
        
        // Religions
        const religions = [
            {name: "Bahamut", domain: "Justice, nobility, good dragons", temples: ["Cathedral of the Platinum Dragon", "Hall of Sacred Justice", "Temple of the Noble Scale"]},
            {name: "Tiamat", domain: "Greed, evil dragons", temples: ["The Five-Headed Shrine", "Temple of Chromatic Scales", "Den of Draconic Might"]},
            {name: "Pelor", domain: "Sun, healing, light", temples: ["Cathedral of Dawn", "Sunlit Sanctuary", "Temple of Eternal Light"]},
            {name: "Corellon Larethian", domain: "Elves, magic, arts", temples: ["The Verdant Spire", "Hall of the First Song", "Temple of Mystic Revelation"]},
            {name: "Moradin", domain: "Dwarves, creation, smithing", temples: ["The Ironhammer Forge", "Temple of the Divine Smith", "Hall of Ancestral Stone"]},
            {name: "Garl Glittergold", domain: "Gnomes, trickery, gems", temples: ["The Glimmering Jest", "Temple of Wondrous Illusion", "Hall of Sparkling Wits"]},
            {name: "Gruumsh", domain: "Orcs, storms, war", temples: ["The One-Eyed Hall", "Temple of Endless Conquest", "Shrine of Bloody Victory"]},
            {name: "Lolth", domain: "Drow, spiders, darkness", temples: ["The Spider Queen's Web", "Temple of Eight Shadows", "Sanctuary of the Endless Night"]},
            {name: "Avandra", domain: "Change, luck, travel", temples: ["Sanctuary of Ever-Changing Winds", "Temple of Fortune's Favor", "Hall of Distant Horizons"]},
            {name: "Sehanine Moonbow", domain: "Moon, dreams, illusions", temples: ["The Lunar Sanctuary", "Temple of Silver Dreams", "Veiled Hall of Mystery"]},
            {name: "Kord", domain: "Strength, storms, battle", temples: ["Hall of Mighty Deeds", "Temple of Thunderous Might", "Shrine of Victorious Champions"]},
            {name: "Erathis", domain: "Civilization, law, invention", temples: ["The Civic Forum", "Temple of Orderly Progress", "Hall of Innovation"]},
            {name: "The Raven Queen", domain: "Death, fate, winter", temples: ["Sanctuary of Final Passage", "Temple of Woven Fate", "Hall of Dark Wings"]},
            {name: "Asmodeus", domain: "Tyranny, contracts, dark power", temples: ["Temple of Binding Oaths", "Shrine of Darkest Ambition", "The Nine-Pillared Hall"]},
            {name: "Ioun", domain: "Knowledge, prophecy, skill", temples: ["Library of All Knowledge", "Temple of Prophecy", "Hall of Endless Learning"]},
            {name: "Melora", domain: "Wilderness, nature, sea", temples: ["Grove of Ancient Boughs", "Temple of Wild Currents", "Sanctuary of Natural Harmony"]},
            {name: "Vecna", domain: "Secrets, undeath, necromancy", temples: ["Sanctum of Hidden Truth", "Temple of Whispered Lore", "Hall of Forbidden Knowledge"]},
            {name: "Zehir", domain: "Darkness, poison, serpents", temples: ["The Serpent's Coil", "Temple of Venomed Fangs", "Shrine of Night's Venom"]}
        ];
        
        // Languages
        const languages = [
            {name: "Common", commonality: 90},
            {name: "Elvish", commonality: 30},
            {name: "Dwarvish", commonality: 30},
            {name: "Halfling", commonality: 20},
            {name: "Gnomish", commonality: 15},
            {name: "Draconic", commonality: 10},
            {name: "Orcish", commonality: 10},
            {name: "Goblin", commonality: 8},
            {name: "Giant", commonality: 5},
            {name: "Undercommon", commonality: 5},
            {name: "Abyssal", commonality: 3},
            {name: "Celestial", commonality: 3},
            {name: "Infernal", commonality: 3},
            {name: "Primordial", commonality: 2},
            {name: "Sylvan", commonality: 10},
            {name: "Deep Speech", commonality: 1}
        ];
        
        // Geography
        const terrains = [
            "Coastal", "Riverside", "Lakeside", "Plains", "Hills", 
            "Mountains", "Forest", "Desert", "Swamp", "Island", 
            "Valley", "Plateau", "Jungle", "Alpine", "Volcanic"
        ];
        
        const climates = [
            {type: "temperate", description: "Mild seasons with moderate rainfall"},
            {type: "tropical", description: "Hot and humid year-round"},
            {type: "arid", description: "Hot and dry with little rainfall"},
            {type: "arctic", description: "Extremely cold with long winters"},
            {type: "alpine", description: "Cool mountain climate with thin air"},
            {type: "mediterranean", description: "Warm, dry summers and mild, wet winters"},
            {type: "continental", description: "Hot summers and cold winters"},
            {type: "oceanic", description: "Mild temperatures with year-round rainfall"}
        ];
        
        const naturalFeatures = [
            "Built atop a massive waterfall",
            "Situated on a natural harbor",
            "Constructed around a giant ancient tree",
            "Built into the mountainside",
            "Nestled between twin peaks",
            "Built across multiple small islands",
            "Situated at the convergence of three rivers",
            "Built around natural hot springs",
            "Located at the edge of a dense forest",
            "Located in a deep valley",
            "Built around a natural sinkhole",
            "Situated on the rim of an extinct volcano",
            "Located at the base of a cliff face",
            "Built on terraced hillsides",
            "Located at the mouth of a river delta",
            "Built around mysterious standing stones",
            "Surrounded by unusual rock formations",
            "Built near healing mineral springs",
            "Located near naturally occurring crystal caves",
            "Built in the shadow of an enormous mountain"
        ];
        
        // Architecture
        const architectureStyles = [
            {
                style: "Dwarven",
                description: "Sturdy stone constructions with intricate geometric patterns",
                features: [
                    "Low, wide archways",
                    "Underground halls and chambers",
                    "Stone buildings with minimal windows",
                    "Geometric decorative patterns",
                    "Heavy use of metal reinforcements",
                    "Compact, efficient layouts"
                ]
            },
            {
                style: "Elven",
                description: "Elegant structures that blend with natural surroundings",
                features: [
                    "Graceful spires and arches",
                    "Buildings incorporated into living trees",
                    "Abundant use of glass and open spaces",
                    "Flowing, organic designs",
                    "Minimal environmental impact",
                    "Delicate, intricate ornamentation"
                ]
            },
            {
                style: "Human Imperial",
                description: "Grand, imposing structures demonstrating wealth and power",
                features: [
                    "Massive stone walls and fortifications",
                    "Tall towers and domes",
                    "Large central plazas",
                    "Impressive government buildings",
                    "Clear social stratification in districts",
                    "Extensive road networks"
                ]
            },
            {
                style: "Halfling",
                description: "Cozy, practical designs focused on comfort",
                features: [
                    "Round doors and windows",
                    "Low-ceilinged but spacious buildings",
                    "Underground or hillside dwellings",
                    "Emphasis on dining and gathering spaces",
                    "Well-tended gardens and greenery",
                    "Colorful, cheerful decorations"
                ]
            },
            {
                style: "Gnomish",
                description: "Whimsical, innovative designs with unusual mechanisms",
                features: [
                    "Unusual, asymmetrical shapes",
                    "Integrated mechanical elements",
                    "Homes with multiple levels and odd angles",
                    "Clever use of space",
                    "Quirky decorative elements",
                    "Experimental construction methods"
                ]
            },
            {
                style: "Dragonborn",
                description: "Bold, imposing structures with draconic motifs",
                features: [
                    "Large, open halls designed for winged beings",
                    "Heat-resistant materials",
                    "Draconic imagery in decoration",
                    "Tall ceilings and doorways",
                    "Platforms rather than staircases",
                    "Emphasis on clan gathering spaces"
                ]
            },
            {
                style: "Gothic",
                description: "Dramatic, vertical designs with religious significance",
                features: [
                    "Flying buttresses and pointed arches",
                    "Tall spires reaching skyward",
                    "Elaborate stained glass windows",
                    "Gargoyles and grotesques",
                    "Ribbed vaults and high ceilings",
                    "Emphasis on vertical lines"
                ]
            },
            {
                style: "Desert",
                description: "Heat-efficient designs using thick walls and minimal openings",
                features: [
                    "Thick walls for temperature regulation",
                    "Small windows to keep out heat",
                    "Flat roofs for nighttime use",
                    "Central courtyards with water features",
                    "Wind-catching towers for ventilation",
                    "Light-colored materials to reflect sunlight"
                ]
            },
            {
                style: "Nordic",
                description: "Sturdy structures designed to withstand harsh winters",
                features: [
                    "Steep-pitched roofs to shed snow",
                    "Heavy timber construction",
                    "Central hearths for heating",
                    "Carved animal motifs",
                    "Communal mead halls",
                    "Minimal openings to preserve heat"
                ]
            },
            {
                style: "Arcane",
                description: "Unusual buildings incorporating magical elements",
                features: [
                    "Floating or levitating structures",
                    "Geometrically impossible architecture",
                    "Glowing magical materials",
                    "Buildings larger inside than outside",
                    "Structures that shift or reconfigure",
                    "Weather-repelling enchantments"
                ]
            }
        ];
        
        // Economy
        const economies = [
            {
                status: "Destitute",
                description: "Extreme poverty with minimal trade or industry",
                features: [
                    "Widespread hunger and poverty",
                    "Abandoned buildings and infrastructure",
                    "Subsistence farming and scavenging",
                    "Few goods available for purchase",
                    "Little to no currency circulation"
                ]
            },
            {
                status: "Struggling",
                description: "Poor economy with limited opportunities",
                features: [
                    "High unemployment",
                    "Basic goods available but expensive",
                    "Single failing industry",
                    "Decaying infrastructure",
                    "Growing black market"
                ]
            },
            {
                status: "Stable",
                description: "Functioning economy meeting basic needs",
                features: [
                    "Steady but limited employment",
                    "Common goods readily available",
                    "Small local markets",
                    "Maintained but aging infrastructure",
                    "Limited currency circulation"
                ]
            },
            {
                status: "Prosperous",
                description: "Thriving economy with abundant trade",
                features: [
                    "Low unemployment",
                    "Diverse goods and services",
                    "Multiple successful industries",
                    "Well-maintained infrastructure",
                    "Active markets and banking"
                ]
            },
            {
                status: "Wealthy",
                description: "Exceptional wealth with luxury trade",
                features: [
                    "Labor shortage rather than unemployment",
                    "Exotic goods commonly available",
                    "Sophisticated financial institutions",
                    "Impressive infrastructure",
                    "Conspicuous consumption by elites"
                ]
            }
        ];
        
        const commonIndustries = [
            "Agriculture", "Fishing", "Logging", "Mining", "Quarrying",
            "Textiles", "Pottery", "Glassblowing", "Brewing", "Winemaking",
            "Smithing", "Woodworking", "Leatherworking", "Shipbuilding", "Masonry",
            "Trade", "Banking", "Education", "Military", "Religious services",
            "Magical research", "Alchemy", "Entertainment", "Art", "Medicine",
            "Animal husbandry", "Jewelry making", "Bookbinding", "Mercenary work", "Spice trading"
        ];
        
        // History & Founding
        const foundingReasons = [
            "Discovery of valuable natural resources",
            "Strategic military location",
            "Religious significance",
            "Natural harbor ideal for trade",
            "Refugee settlement after a disaster",
            "Colony established by a larger power",
            "Founded around a magical phenomenon",
            "Settlement at a major trade crossroads",
            "Built on ruins of an ancient civilization",
            "Outpost to monitor dangerous wilderness",
            "Founded by exiles or outcasts",
            "Settlement around a famous shrine or temple",
            "Grew from a military fort or garrison",
            "Founded by a famous hero or adventurer",
            "Created by royal decree as a planned city",
            "Magical experiment that created habitable land",
            "Settlement at the site of a legendary event",
            "Founded by a specific guild or organization",
            "Natural disaster forced relocation from elsewhere",
            "Built to exploit a nearby dungeon or magical site"
        ];
        
        const historicalEvents = [
            "Great fire destroyed much of the settlement",
            "Devastating plague decimated the population",
            "Major battle fought within or near city walls",
            "Overthrow of previous ruling system",
            "Discovery of major resource changed the economy",
            "Magical catastrophe altered the local area",
            "Siege by enemy forces",
            "Period of rapid expansion and growth",
            "Colonization by foreign power",
            "Declaration of independence",
            "Religious reformation or conversion",
            "Establishment of famous institution or landmark",
            "Visit by legendary figure or deity",
            "Economic boom due to new trade routes",
            "Natural disaster (earthquake, flood, etc.)",
            "Treaty signing ending a major conflict",
            "Absorption of neighboring settlements",
            "Magical blessing or curse affecting generations",
            "Successful repelling of monster attack or invasion",
            "Discovery of ancient ruins beneath the city"
        ];
        
        // Flag Elements
        const flagColors = [
            {name: "Red", hex: "#C9252C", meaning: "courage, revolution, hardiness"},
            {name: "Blue", hex: "#144B8C", meaning: "vigilance, truth, loyalty, perseverance"},
            {name: "Green", hex: "#216E39", meaning: "hope, joy, forests, fertility"},
            {name: "Yellow", hex: "#FED430", meaning: "wealth, sun, energy, joy"},
            {name: "Purple", hex: "#6A2F7A", meaning: "royalty, nobility, ceremony"},
            {name: "Black", hex: "#212121", meaning: "determination, ethnic heritage, defeating enemies"},
            {name: "White", hex: "#F3F3F3", meaning: "peace, purity, harmony"},
            {name: "Orange", hex: "#E87C33", meaning: "courage, sacrifice, success"},
            {name: "Brown", hex: "#76462C", meaning: "earth, simplicity, endurance"},
            {name: "Gold", hex: "#D4AF37", meaning: "prosperity, wisdom, wealth, high status"},
            {name: "Silver", hex: "#C0C0C0", meaning: "serenity, clarity, focus"}
        ];
        
        const flagPatterns = [
            "horizontal-2", "horizontal-3", "vertical-2", "vertical-3", "diagonal", 
            "quartered", "checkerboard", "striped", "crossed", "bordered", "solid"
        ];
        
        const flagSymbols = [
            {icon: "spa", meaning: "nature, growth, harmony"},
            {icon: "pets", meaning: "loyalty, protection"},
            {icon: "castle", meaning: "strength, security, nobility"},
            {icon: "anchor", meaning: "naval power, stability"},
            {icon: "water", meaning: "life, purity, movement"},
            {icon: "agriculture", meaning: "farming, prosperity"},
            {icon: "bolt", meaning: "power, speed, energy"},
            {icon: "star", meaning: "divine guidance, excellence"},
            {icon: "brightness_7", meaning: "life, power, glory"},
            {icon: "terrain", meaning: "permanence, foundation, earth"},
            {icon: "forest", meaning: "growth, abundance, nature"},
            {icon: "military_tech", meaning: "achievement, honor, victory"},
            {icon: "security", meaning: "protection, safety"},
            {icon: "lan", meaning: "connection, community"},
            {icon: "balance", meaning: "justice, equality, harmony"},
            {icon: "flare", meaning: "enlightenment, guidance"},
            {icon: "sports_martial_arts", meaning: "strength, discipline, combat prowess"},
            {icon: "diamond", meaning: "wealth, endurance, purity"},
            {icon: "flight", meaning: "freedom, aspiration, swift movement"},
            {icon: "local_fire_department", meaning: "purification, transformation, passion"}
        ];
        
        // Random Number Utilities
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function getRandomFloat(min, max, decimals = 1) {
            const num = Math.random() * (max - min) + min;
            return Number(num.toFixed(decimals));
        }
        
        function getRandomElement(array) {
            return array[Math.floor(Math.random() * array.length)];
        }
        
        // Weighted random selection
        function getWeightedRandom(items, weightProperty) {
            const totalWeight = items.reduce((acc, item) => acc + item[weightProperty], 0);
            let random = Math.random() * totalWeight;
            
            for (const item of items) {
                random -= item[weightProperty];
                if (random < 0) {
                    return item;
                }
            }
            
            return items[0]; // Fallback
        }
        
        // Generate proportional racial demographics
        function generateRacialDemographics() {
            // Make a copy to avoid modifying original
            const availableRaces = [...races];
            const demographics = [];
            let remainingPercentage = 100;
            
            // Pick dominant race
            const dominantRace = getWeightedRandom(availableRaces, "commonality");
            const dominantIndex = availableRaces.findIndex(r => r.name === dominantRace.name);
            availableRaces.splice(dominantIndex, 1);
            
            // Assign percentage to dominant race (40-75%)
            const dominantPercentage = getRandomInt(40, 75);
            demographics.push({race: dominantRace.name, percentage: dominantPercentage});
            remainingPercentage -= dominantPercentage;
            
            // Pick secondary races
            const numberOfSecondaryRaces = getRandomInt(2, 4);
            for (let i = 0; i < numberOfSecondaryRaces && availableRaces.length > 0; i++) {
                const secondaryRace = getWeightedRandom(availableRaces, "commonality");
                const secondaryIndex = availableRaces.findIndex(r => r.name === secondaryRace.name);
                availableRaces.splice(secondaryIndex, 1);
                
                let percentage;
                if (i === numberOfSecondaryRaces - 1 || availableRaces.length === 0) {
                    // Last one gets remainder
                    percentage = remainingPercentage;
                } else if (demographics[0].race === "Halfling" && demographics[0].percentage > 40) {
                foundingRace = "Halfling settlers";
            } else if (demographics[0].race === "Gnome" && demographics[0].percentage > 40) {
                foundingRace = "Gnomish inventors";
            } else {
                foundingRace = "Human expedition";
            } {
                    // Make sure we leave some percentage for others
                    const maxAllocation = remainingPercentage - (numberOfSecondaryRaces - i - 1);
                    percentage = getRandomInt(1, Math.max(1, maxAllocation));
                }
                
                demographics.push({race: secondaryRace.name, percentage: percentage});
                remainingPercentage -= percentage;
            }
            
            // Add "Other" category if there's anything left
            if (remainingPercentage > 0) {
                demographics.push({race: "Other", percentage: remainingPercentage});
            }
            
            return demographics.sort((a, b) => b.percentage - a.percentage);
        }
        
        // Generate languages based on demographics
        function generateLanguages(demographics) {
            const cityLanguages = [];
            const officialLanguage = "Common";
            cityLanguages.push({language: officialLanguage, status: "official", percentage: 95});
            
            // Add languages based on racial demographics
            demographics.forEach(demo => {
                if (demo.race === "Human") return; // Humans typically use Common
                
                const raceLanguage = demo.race === "Half-Elf" ? "Elvish" :
                                    demo.race === "Half-Orc" ? "Orcish" :
                                    demo.race + "ish"; // Dwarvish, Elvish, etc.
                
                const languageObj = languages.find(l => l.name === raceLanguage);
                if (languageObj) {
                    const status = demo.percentage > 30 ? "common" : 
                                demo.percentage > 15 ? "minority" : "rare";
                    
                    // Calculate rough percentage of speakers (lower than demographic %)
                    const speakerPercentage = Math.round(demo.percentage * getRandomFloat(0.5, 0.9));
                    
                    cityLanguages.push({
                        language: raceLanguage,
                        status: status,
                        percentage: speakerPercentage
                    });
                }
            });
            
            // Potentially add 1-2 additional languages
            const numAdditional = getRandomInt(0, 2);
            for (let i = 0; i < numAdditional; i++) {
                const additionalLang = getWeightedRandom(languages, "commonality");
                if (!cityLanguages.some(l => l.language === additionalLang.name)) {
                    cityLanguages.push({
                        language: additionalLang.name,
                        status: "specialized",
                        percentage: getRandomInt(3, 15)
                    });
                }
            }
            
            return cityLanguages;
        }
        
        // Generate religions
        function generateReligions() {
            const cityReligions = [];
            const numMainReligions = getRandomInt(1, 4);
            const usedReligions = [];
            let remainingPercentage = 100;
            
            // Select main religions
            for (let i = 0; i < numMainReligions; i++) {
                let religion;
                do {
                    religion = getRandomElement(religions);
                } while (usedReligions.includes(religion.name));
                
                usedReligions.push(religion.name);
                
                let percentage;
                if (i === 0) {
                    // Dominant religion
                    percentage = getRandomInt(30, 70);
                } else if (i === numMainReligions - 1) {
                    // Last one gets remainder
                    percentage = remainingPercentage;
                } else {
                    // Secondary religions
                    percentage = getRandomInt(5, remainingPercentage - 5);
                }
                
                cityReligions.push({
                    name: religion.name,
                    domain: religion.domain,
                    percentage: percentage,
                    temple: getRandomElement(religion.temples)
                });
                
                remainingPercentage -= percentage;
            }
            
            // If there's still a percentage left, add "Various minor faiths"
            if (remainingPercentage > 0) {
                cityReligions.push({
                    name: "Various minor faiths",
                    domain: "Various",
                    percentage: remainingPercentage,
                    temple: "Small shrines throughout the city"
                });
            }
            
            return cityReligions.sort((a, b) => b.percentage - a.percentage);
        }
        
        // Generate the flag HTML
        function generateFlag() {
            const flagContainer = document.getElementById('flag');
            flagContainer.innerHTML = '';
            
            // Select random pattern and colors
            const pattern = getRandomElement(flagPatterns);
            const primaryColor = getRandomElement(flagColors);
            let secondaryColor;
            do {
                secondaryColor = getRandomElement(flagColors);
            } while (secondaryColor.name === primaryColor.name);
            
            let tertiaryColor;
            do {
                tertiaryColor = getRandomElement(flagColors);
            } while (tertiaryColor.name === primaryColor.name || tertiaryColor.name === secondaryColor.name);
            
            // Create SVG element
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", "0 0 300 180");
            
            // Create pattern based on selection
            switch (pattern) {
                case "horizontal-2":
                    // Two horizontal stripes
                    const rectTop = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rectTop.setAttribute("x", "0");
                    rectTop.setAttribute("y", "0");
                    rectTop.setAttribute("width", "300");
                    rectTop.setAttribute("height", "90");
                    rectTop.setAttribute("fill", primaryColor.hex);
                    
                    const rectBottom = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rectBottom.setAttribute("x", "0");
                    rectBottom.setAttribute("y", "90");
                    rectBottom.setAttribute("width", "300");
                    rectBottom.setAttribute("height", "90");
                    rectBottom.setAttribute("fill", secondaryColor.hex);
                    
                    svg.appendChild(rectTop);
                    svg.appendChild(rectBottom);
                    break;
                
                case "horizontal-3":
                    // Three horizontal stripes
                    const rect1 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect1.setAttribute("x", "0");
                    rect1.setAttribute("y", "0");
                    rect1.setAttribute("width", "300");
                    rect1.setAttribute("height", "60");
                    rect1.setAttribute("fill", primaryColor.hex);
                    
                    const rect2 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect2.setAttribute("x", "0");
                    rect2.setAttribute("y", "60");
                    rect2.setAttribute("width", "300");
                    rect2.setAttribute("height", "60");
                    rect2.setAttribute("fill", secondaryColor.hex);
                    
                    const rect3 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect3.setAttribute("x", "0");
                    rect3.setAttribute("y", "120");
                    rect3.setAttribute("width", "300");
                    rect3.setAttribute("height", "60");
                    rect3.setAttribute("fill", tertiaryColor.hex);
                    
                    svg.appendChild(rect1);
                    svg.appendChild(rect2);
                    svg.appendChild(rect3);
                    break;
                
                case "vertical-2":
                    // Two vertical stripes
                    const rectLeft = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rectLeft.setAttribute("x", "0");
                    rectLeft.setAttribute("y", "0");
                    rectLeft.setAttribute("width", "150");
                    rectLeft.setAttribute("height", "180");
                    rectLeft.setAttribute("fill", primaryColor.hex);
                    
                    const rectRight = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rectRight.setAttribute("x", "150");
                    rectRight.setAttribute("y", "0");
                    rectRight.setAttribute("width", "150");
                    rectRight.setAttribute("height", "180");
                    rectRight.setAttribute("fill", secondaryColor.hex);
                    
                    svg.appendChild(rectLeft);
                    svg.appendChild(rectRight);
                    break;
                
                case "vertical-3":
                    // Three vertical stripes
                    const rectV1 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rectV1.setAttribute("x", "0");
                    rectV1.setAttribute("y", "0");
                    rectV1.setAttribute("width", "100");
                    rectV1.setAttribute("height", "180");
                    rectV1.setAttribute("fill", primaryColor.hex);
                    
                    const rectV2 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rectV2.setAttribute("x", "100");
                    rectV2.setAttribute("y", "0");
                    rectV2.setAttribute("width", "100");
                    rectV2.setAttribute("height", "180");
                    rectV2.setAttribute("fill", secondaryColor.hex);
                    
                    const rectV3 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rectV3.setAttribute("x", "200");
                    rectV3.setAttribute("y", "0");
                    rectV3.setAttribute("width", "100");
                    rectV3.setAttribute("height", "180");
                    rectV3.setAttribute("fill", tertiaryColor.hex);
                    
                    svg.appendChild(rectV1);
                    svg.appendChild(rectV2);
                    svg.appendChild(rectV3);
                    break;
                
                case "diagonal":
                    // Diagonal split
                    const bg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    bg.setAttribute("x", "0");
                    bg.setAttribute("y", "0");
                    bg.setAttribute("width", "300");
                    bg.setAttribute("height", "180");
                    bg.setAttribute("fill", primaryColor.hex);
                    
                    const diagonal = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                    diagonal.setAttribute("points", "0,0 300,180 300,0");
                    diagonal.setAttribute("fill", secondaryColor.hex);
                    
                    svg.appendChild(bg);
                    svg.appendChild(diagonal);
                    break;
                
                case "quartered":
                    // Four quarters
                    const q1 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    q1.setAttribute("x", "0");
                    q1.setAttribute("y", "0");
                    q1.setAttribute("width", "150");
                    q1.setAttribute("height", "90");
                    q1.setAttribute("fill", primaryColor.hex);
                    
                    const q2 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    q2.setAttribute("x", "150");
                    q2.setAttribute("y", "0");
                    q2.setAttribute("width", "150");
                    q2.setAttribute("height", "90");
                    q2.setAttribute("fill", secondaryColor.hex);
                    
                    const q3 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    q3.setAttribute("x", "0");
                    q3.setAttribute("y", "90");
                    q3.setAttribute("width", "150");
                    q3.setAttribute("height", "90");
                    q3.setAttribute("fill", secondaryColor.hex);
                    
                    const q4 = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    q4.setAttribute("x", "150");
                    q4.setAttribute("y", "90");
                    q4.setAttribute("width", "150");
                    q4.setAttribute("height", "90");
                    q4.setAttribute("fill", primaryColor.hex);
                    
                    svg.appendChild(q1);
                    svg.appendChild(q2);
                    svg.appendChild(q3);
                    svg.appendChild(q4);
                    break;
                
                case "checkerboard":
                    // Checkerboard pattern
                    const bgCheck = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    bgCheck.setAttribute("x", "0");
                    bgCheck.setAttribute("y", "0");
                    bgCheck.setAttribute("width", "300");
                    bgCheck.setAttribute("height", "180");
                    bgCheck.setAttribute("fill", primaryColor.hex);
                    
                    svg.appendChild(bgCheck);
                    
                    // Create 3x5 checkerboard
                    for (let i = 0; i < 3; i++) {
                        for (let j = 0; j < 5; j++) {
                            if ((i + j) % 2 === 1) {
                                const square = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                                square.setAttribute("x", j * 60);
                                square.setAttribute("y", i * 60);
                                square.setAttribute("width", "60");
                                square.setAttribute("height", "60");
                                square.setAttribute("fill", secondaryColor.hex);
                                svg.appendChild(square);
                            }
                        }
                    }
                    break;
                
                case "striped":
                    // Horizontal stripes
                    const bgStripe = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    bgStripe.setAttribute("x", "0");
                    bgStripe.setAttribute("y", "0");
                    bgStripe.setAttribute("width", "300");
                    bgStripe.setAttribute("height", "180");
                    bgStripe.setAttribute("fill", primaryColor.hex);
                    
                    svg.appendChild(bgStripe);
                    
                    // Create stripes
                    for (let i = 0; i < 9; i += 2) {
                        const stripe = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                        stripe.setAttribute("x", "0");
                        stripe.setAttribute("y", i * 20);
                        stripe.setAttribute("width", "300");
                        stripe.setAttribute("height", "20");
                        stripe.setAttribute("fill", secondaryColor.hex);
                        svg.appendChild(stripe);
                    }
                    break;
                
                case "crossed":
                    // Cross pattern
                    const bgCross = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    bgCross.setAttribute("x", "0");
                    bgCross.setAttribute("y", "0");
                    bgCross.setAttribute("width", "300");
                    bgCross.setAttribute("height", "180");
                    bgCross.setAttribute("fill", primaryColor.hex);
                    
                    const hCross = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    hCross.setAttribute("x", "0");
                    hCross.setAttribute("y", "60");
                    hCross.setAttribute("width", "300");
                    hCross.setAttribute("height", "60");
                    hCross.setAttribute("fill", secondaryColor.hex);
                    
                    const vCross = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    vCross.setAttribute("x", "120");
                    vCross.setAttribute("y", "0");
                    vCross.setAttribute("width", "60");
                    vCross.setAttribute("height", "180");
                    vCross.setAttribute("fill", secondaryColor.hex);
                    
                    svg.appendChild(bgCross);
                    svg.appendChild(hCross);
                    svg.appendChild(vCross);
                    break;
                
                case "bordered":
                    // Border pattern
                    const bgBorder = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    bgBorder.setAttribute("x", "0");
                    bgBorder.setAttribute("y", "0");
                    bgBorder.setAttribute("width", "300");
                    bgBorder.setAttribute("height", "180");
                    bgBorder.setAttribute("fill", primaryColor.hex);
                    
                    const innerBorder = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    innerBorder.setAttribute("x", "20");
                    innerBorder.setAttribute("y", "20");
                    innerBorder.setAttribute("width", "260");
                    innerBorder.setAttribute("height", "140");
                    innerBorder.setAttribute("fill", secondaryColor.hex);
                    
                    svg.appendChild(bgBorder);
                    svg.appendChild(innerBorder);
                    break;
                
                case "solid":
                default:
                    // Solid color with optional emblem
                    const solid = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    solid.setAttribute("x", "0");
                    solid.setAttribute("y", "0");
                    solid.setAttribute("width", "300");
                    solid.setAttribute("height", "180");
                    solid.setAttribute("fill", primaryColor.hex);
                    
                    svg.appendChild(solid);
                    break;
            }
            
            // Add a symbol (50% chance)
            if (Math.random() > 0.5) {
                const symbol = getRandomElement(flagSymbols);
                const foreignObject = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                foreignObject.setAttribute("x", "120");
                foreignObject.setAttribute("y", "60");
                foreignObject.setAttribute("width", "60");
                foreignObject.setAttribute("height", "60");
                
                const div = document.createElement("div");
                div.style.width = "100%";
                div.style.height = "100%";
                div.style.display = "flex";
                div.style.alignItems = "center";
                div.style.justifyContent = "center";
                
                const icon = document.createElement("span");
                icon.className = "material-icons";
                icon.style.fontSize = "48px";
                icon.style.color = ["horizontal-2", "horizontal-3", "vertical-2", "vertical-3", "quartered", "checkerboard", "striped", "crossed"].includes(pattern) ? tertiaryColor.hex : "#fff";
                icon.textContent = symbol.icon;
                
                div.appendChild(icon);
                foreignObject.appendChild(div);
                svg.appendChild(foreignObject);
            }
            
            flagContainer.appendChild(svg);
        }
        
        // Generate complete city
        function generateCity() {
            // Get filter values
            const sizeFilter = document.getElementById('size-filter').value;
            const governmentFilter = document.getElementById('government-filter').value;
            const climateFilter = document.getElementById('climate-filter').value;
            
            // Generate City Name
            const prefix = getRandomElement(prefixes);
            const suffix = getRandomElement(suffixes);
            const cityName = prefix + suffix;
            
            // Generate nickname
            const nicknameType = Math.random() > 0.5 ? "adjective" : "noun";
            let nickname;
            
            if (nicknameType === "adjective") {
                nickname = `"The ${getRandomElement(nicknameAdjectives)} ${getRandomElement(nicknameNouns)}"`;
            } else {
                nickname = `"${getRandomElement(nicknamePrefix)} ${getRandomElement(nicknameNouns)}"`;
            }
            
            // Generate Size and Population
            let citySize;
            if (sizeFilter !== "any") {
                citySize = citySizes.find(size => size.type === sizeFilter);
            } else {
                citySize = getRandomElement(citySizes);
            }
            
            const population = getRandomInt(citySize.minPop, citySize.maxPop);
            const formattedPopulation = population.toLocaleString();
            
            // Generate Demographics
            const demographics = generateRacialDemographics();
            const demographicsHTML = demographics.map(d => `<div>${d.race}: ${d.percentage}%</div>`).join('');
            
            // Generate Birth Rate, Growth Rate, and Median Age
            const birthRate = getRandomFloat(10.0, 30.0, 1);
            const growthRate = getRandomFloat(-2.0, 5.0, 1);
            const medianAge = getRandomInt(25, 60);
            
            // Generate Geography
            const terrain = getRandomElement(terrains);
            let climate;
            if (climateFilter !== "any") {
                climate = climates.find(c => c.type === climateFilter);
            } else {
                climate = getRandomElement(climates);
            }
            
            const size = getRandomFloat(0.5, 25.0, 1);
            const elevation = getRandomInt(0, 8000);
            
            // Natural Features
            const numFeatures = getRandomInt(2, 4);
            const features = [];
            for (let i = 0; i < numFeatures; i++) {
                let feature;
                do {
                    feature = getRandomElement(naturalFeatures);
                } while (features.includes(feature));
                features.push(feature);
            }
            
            const featuresHTML = features.map(f => `<li>${f}</li>`).join('');
            
            // Generate Government
            let government;
            if (governmentFilter !== "any") {
                government = governments.find(g => g.type === governmentFilter);
            } else {
                government = getRandomElement(governments);
            }
            
            const leaderTitle = getRandomElement(government.titles);
            const stability = getRandomElement(government.stability);
            const corruption = getRandomElement(["None", "Low", "Moderate", "High", "Extreme"]);
            
            // Leader Name
            const leaderRace = getRandomElement(demographics.filter(d => d.race !== "Other")).race;
            
            const humanFirstNames = ["Aldric", "Bram", "Cedric", "Elias", "Gareth", "Hector", "Isabel", "Johanna", "Katarina", "Lydia", "Magnus", "Nathaniel", "Octavia", "Roland", "Serena", "Thaddeus", "Ursula", "Viktor", "Winifred", "Yvette"];
            const elfFirstNames = ["Adran", "Birel", "Caladrel", "Elnaril", "Faelar", "Gaelin", "Ielenia", "Lysanthir", "Morian", "Naesala", "Oleander", "Phirosalle", "Quillathe", "Riardon", "Silaqui", "Thervan", "Valandil", "Xiloscent", "Yathlanae", "Zeno"];
            const dwarfFirstNames = ["Barendd", "Brottor", "Eberk", "Flint", "Gimurt", "Harbek", "Kildrak", "Morgran", "Orsik", "Rangrim", "Suorr", "Tharden", "Thorin", "Tordek", "Traubon", "Travok", "Ulfgar", "Veit", "Vondal", "Yngvar"];
            const halflingFirstNames = ["Alton", "Beau", "Cade", "Eldon", "Finnan", "Garret", "Lindal", "Milo", "Osborn", "Perrin", "Reed", "Roscoe", "Wellby", "Wilbur", "Andry", "Bree", "Callie", "Euphamia", "Jillian", "Kitty", "Lavinia", "Merla", "Portia", "Seraphina"];
            const gnomeFirstNames = ["Boddynock", "Dimble", "Fonkin", "Gimble", "Glim", "Gerbo", "Namfoodle", "Orryn", "Roondar", "Zook", "Bimpnottin", "Caramip", "Duvamil", "Ellywick", "Loopmottin", "Mardnab", "Roywyn", "Shamil", "Waywocket"];
            const lastNames = ["Thorngage", "Silverstone", "Oakenheart", "Ironfist", "Blackwood", "Frostmantle", "Goldseeker", "Stormcloud", "Deepdelver", "Highwind", "Copperpot", "Shadowcloak", "Brightshield", "Fireforge", "Wyvernrider", "Griffinbane", "Moonwhisper", "Sunwalker", "Earthshaker", "Hillstrider"];
            
            let firstName;
            switch (leaderRace) {
                case "Human":
                    firstName = getRandomElement(humanFirstNames);
                    break;
                case "Elf":
                    firstName = getRandomElement(elfFirstNames);
                    break;
                case "Dwarf":
                    firstName = getRandomElement(dwarfFirstNames);
                    break;
                case "Halfling":
                    firstName = getRandomElement(halflingFirstNames);
                    break;
                case "Gnome":
                    firstName = getRandomElement(gnomeFirstNames);
                    break;
                default:
                    firstName = getRandomElement(humanFirstNames);
            }
            
            const lastName = getRandomElement(lastNames);
            const leaderAge = leaderRace === "Elf" ? getRandomInt(100, 700) : 
                             leaderRace === "Dwarf" ? getRandomInt(50, 250) : 
                             getRandomInt(25, 70);
            
            const leaderName = `${firstName} ${lastName}`;
            
            // Government Feature
            const governmentFeature = getRandomElement(government.features);
            const guardCount = citySize.guards;
            
            const governmentDetailsHTML = `
                <p>${governmentFeature}</p>
                <p>Current ${leaderTitle}: <strong>${leaderName}</strong> (${leaderRace}, ${leaderAge} years old)</p>
                <p>The city guard numbers ${guardCount} well-trained individuals.</p>
            `;
            
            // Generate Economy
            const economy = getRandomElement(economies);
            const taxRate = getRandomInt(5, 25);
            
            // Trading Status based on size
            let tradeStatus;
            if (citySize.type === "metropolis") {
                tradeStatus = getRandomElement(["International Hub", "Trade Capital", "Regional Center"]);
            } else if (citySize.type === "city") {
                tradeStatus = getRandomElement(["Regional Hub", "Major Trading Port", "Established Market"]);
            } else if (citySize.type === "town") {
                tradeStatus = getRandomElement(["Local Market", "Trade Stop", "Developing Hub"]);
            } else {
                tradeStatus = getRandomElement(["Local Exchange", "Minor Market", "Self-Sufficient"]);
            }
            
            // Currency Type
            const currencyType = getRandomElement(["Standard", "Standard + Local", "Local Only", "Barter + Standard", "Foreign Currency"]);
            
            // Industries
            const numIndustries = getRandomInt(2, 5);
            const industries = [];
            for (let i = 0; i < numIndustries; i++) {
                let industry;
                do {
                    industry = getRandomElement(commonIndustries);
                } while (industries.includes(industry));
                industries.push(industry);
            }
            
            const primaryIndustry = industries[0];
            const industriesHTML = [
                `<div>${primaryIndustry} (primary export)</div>`,
                ...industries.slice(1).map(ind => `<div>${ind}</div>`)
            ].join('');
            
            // Generate Languages
            const cityLanguages = generateLanguages(demographics);
            const languagesHTML = cityLanguages.map(lang => {
                const statusText = lang.status === "official" ? " (official)" : 
                                  lang.status === "common" ? " (common in trade)" : 
                                  lang.status === "minority" ? " (spoken by minorities)" : 
                                  lang.status === "specialized" ? " (used in academic settings)" : "";
                return `<div>${lang.language}${statusText}</div>`;
            }).join('');
            
            // Literacy Rate based on economy and size
            let literacyBase = 0;
            if (economy.status === "Wealthy") literacyBase = 75;
            else if (economy.status === "Prosperous") literacyBase = 60;
            else if (economy.status === "Stable") literacyBase = 40;
            else if (economy.status === "Struggling") literacyBase = 25;
            else literacyBase = 15;
            
            // Adjust based on size
            if (citySize.type === "metropolis") literacyBase += 15;
            else if (citySize.type === "city") literacyBase += 10;
            else if (citySize.type === "town") literacyBase += 5;
            else if (citySize.type === "hamlet") literacyBase -= 5;
            
            // Clamp between 5 and 95
            const literacyRate = Math.max(5, Math.min(95, literacyBase));
            
            // Generate Crime Rate
            let crimeRateBase;
            if (economy.status === "Destitute") crimeRateBase = ["High", "Extreme"];
            else if (economy.status === "Struggling") crimeRateBase = ["Moderate", "High"];
            else if (economy.status === "Stable") crimeRateBase = ["Low", "Moderate"];
            else if (economy.status === "Prosperous") crimeRateBase = ["Very Low", "Low"];
            else crimeRateBase = ["Minimal", "Very Low"];
            
            const crimeRate = getRandomElement(crimeRateBase);
            
            // Crime Guild or Organization
            const guildPrefixes = ["Shadow", "Silent", "Black", "Crimson", "Hidden", "Iron", "Midnight", "Veiled", "Golden", "Silver"];
            const guildSuffixes = ["Hand", "Fist", "Blade", "Guild", "Brotherhood", "Syndicate", "Network", "Ring", "Society", "Daggers"];
            const guildName = getRandomElement(guildPrefixes) + " " + getRandomElement(guildSuffixes);
            
            const crimeTypes = ["smuggling", "theft", "extortion", "assassination", "gambling", "racketeering", "forgery", "pickpocketing", "burglary", "information brokering"];
            const crimeFocus = getRandomElement(crimeTypes);
            
            const crimeTargets = ["nobility", "merchants", "visitors", "the poor", "rival gangs", "religious groups", "guild members", "government officials", "foreign nationals", "anyone with coin"];
            const crimeTarget = getRandomElement(crimeTargets);
            
            const crimeDetailsHTML = `<p>The ${guildName} operates a ${crimeRate === "High" || crimeRate === "Extreme" ? "large" : "small"} network specializing in ${crimeFocus}, but mainly targets ${crimeTarget}.</p>`;
            
            // Punishment Severity
            const punishmentSeverity = getRandomElement(["Lenient", "Moderate", "Strict", "Harsh", "Brutal"]);
            
            // Generate Religions
            const cityReligions = generateReligions();
            const religionsHTML = cityReligions.map(rel => 
                `<div>${rel.name}, ${rel.domain.split(',')[0]} (${rel.percentage}%)</div>`
            ).join('');
            
            const holySitesHTML = cityReligions.map(rel => 
                `<li>${rel.temple} (${rel.name})</li>`
            ).join('');
            
            // Generate Architecture
            const architecture = getRandomElement(architectureStyles);
            
            const wallTypes = ["None", "Wooden palisade", "Stone, 15ft high", "Stone, 25ft high", "Massive stone, 40ft high", "Ancient magical walls"];
            const wallHeight = citySize.type === "hamlet" || citySize.type === "village" ? 
                             getRandomElement(["None", "Wooden palisade"]) : 
                             getRandomElement(wallTypes);
            
            const streetTypes = ["Dirt paths", "Gravel roads", "Cobblestone", "Fitted stone", "Brick-lined", "Magical smooth stone"];
            const streetType = citySize.type === "hamlet" ? "Dirt paths" : citySize.type === "village" ? getRandomElement(["Dirt paths", "Gravel roads"]) : getRandomElement(streetTypes);
            
            const sewerSystem = citySize.type === "hamlet" || citySize.type === "village" ? "None" : citySize.type === "town" ? getRandomElement(["None", "Basic", "Adequate"]) : getRandomElement(["Basic", "Adequate", "Extensive", "Advanced"]);
            
            // Notable Structures
            const structureTypes = [
                "Guildhall", "Temple", "Library", "Castle", "Palace", "Market", "Tower", 
                "Bridge", "Arena", "Theater", "University", "Observatory", "Monument", 
                "Bathhouse", "Inn", "Tavern", "Dock", "Lighthouse", "Statue", "Garden"
            ];
            
            const descriptors = [
                "Grand", "Ancient", "Magnificent", "Imposing", "Elegant", "Mysterious", 
                "Sprawling", "Ornate", "Colossal", "Enchanted", "Notorious", "Famous", 
                "Hidden", "Sacred", "Forbidden", "Royal", "Golden", "Marble", "Crystal", "Iron"
            ];
            
            const numStructures = getRandomInt(2, 5);
            const structures = [];
            
            for (let i = 0; i < numStructures; i++) {
                let structureType;
                do {
                    structureType = getRandomElement(structureTypes);
                } while (structures.some(s => s.includes(structureType)));
                
                const descriptor = getRandomElement(descriptors);
                const structureName = `The ${descriptor} ${structureType}`;
                structures.push(structureName);
            }
            
            const structuresHTML = structures.map(s => `<li>${s}</li>`).join('');
            
            // Districts
            let numDistricts;
            if (citySize.type === "hamlet") numDistricts = 0;
            else if (citySize.type === "village") numDistricts = getRandomInt(0, 2);
            else if (citySize.type === "town") numDistricts = getRandomInt(2, 3);
            else if (citySize.type === "city") numDistricts = getRandomInt(3, 5);
            else numDistricts = getRandomInt(5, 8);
            
            const districtTypes = [
                {name: "Noble", description: "nobility, government"},
                {name: "Merchant", description: "markets, shops, guilds"},
                {name: "Craft", description: "artisans, workshops"},
                {name: "Temple", description: "religious buildings, clergy"},
                {name: "Garden", description: "parks, wealthy homes"},
                {name: "University", description: "schools, libraries, scholars"},
                {name: "Harbor", description: "docks, warehouses, sailors"},
                {name: "Market", description: "trading, commerce"},
                {name: "Slums", description: "poverty, crime"},
                {name: "Foreign", description: "immigrants, exotic goods"},
                {name: "Entertainment", description: "theaters, taverns, pleasure"},
                {name: "Military", description: "barracks, training grounds"},
                {name: "Industrial", description: "factories, smoke, noise"},
                {name: "Magical", description: "wizard towers, enchantments"},
                {name: "Mining", description: "ore processing, miners"},
                {name: "Residential", description: "housing, small shops"}
            ];
            
            const districtNames = [
                "Hill", "Quarter", "District", "Ward", "Side", "End", "Gate", "Row", 
                "Heights", "Market", "Square", "Circus", "Court", "Gardens", "Alley", 
                "Commons", "Plaza", "Center", "Point", "Haven", "Exchange"
            ];
            
            const districts = [];
            if (numDistricts > 0) {
                const usedTypes = [];
                
                for (let i = 0; i < numDistricts; i++) {
                    let districtType;
                    do {
                        districtType = getRandomElement(districtTypes);
                    } while (usedTypes.includes(districtType.name));
                    
                    usedTypes.push(districtType.name);
                    
                    const prefix = getRandomElement([
                        "North", "South", "East", "West", "Upper", "Lower", "Old", "New",
                        "High", "Low", "Inner", "Outer", "Great", "Little", "Golden", "Silver",
                        "Royal", "Common", "Noble", "Grand"
                    ]);
                    
                    const suffix = getRandomElement(districtNames);
                    
                    const districtName = i === 0 ? 
                                      Math.random() > 0.7 ? `The ${districtType.name} ${suffix}` : `${prefix}${suffix}` : 
                                      Math.random() > 0.5 ? `${prefix} ${districtType.name}` : `${districtType.name} ${suffix}`;
                    
                    districts.push({name: districtName, description: districtType.description});
                }
            }
            
            const districtsHTML = districts.map(d => `<div>${d.name} (${d.description})</div>`).join('');
            
            // Generate History
            const foundingYears = getRandomInt(20, 1200);
            const foundingReason = getRandomElement(foundingReasons);
            
            // Determine founding race based on demographics and architecture
            let foundingRace;
            if (architecture.style === "Dwarven") {
                foundingRace = "Dwarven miners";
            } else if (architecture.style === "Elven") {
                foundingRace = "Elven settlers";
            } else if (demographics[0].race === "Dwarf" && demographics[0].percentage > 40) {
                foundingRace = "Dwarven clan";
            } else if (demographics[0].race === "Elf" && demographics[0].percentage > 40) {
                foundingRace = "Elven community";
            } else {
                foundingRace = "Human expedition";
            }
            
            const historicalEventsHTML = `<li><strong>Year ${getRandomInt(1, foundingYears)}</strong>: City founded due to ${getRandomElement(["resource discovery", "strategic location", "religious significance"])}</li>`;
            const legendsHTML = `<p>It's said that a mysterious force watches over the city.</p>`;
            
            // Update DOM with generated values
            document.querySelector('.city-name').textContent = cityName;
            document.querySelector('.city-nickname').textContent = nickname;
            document.querySelector('#demographics-list').innerHTML = demographicsHTML;
            const statValues = document.querySelectorAll('.stat-value');
            if (statValues.length >= 25) {
                statValues[0].textContent = formattedPopulation;
                statValues[1].textContent = growthRate >= 0 ? `+${growthRate}%/year` : `${growthRate}%/year`;
                statValues[2].textContent = `${birthRate} per 1000`;
                statValues[3].textContent = `${medianAge} years`;
                statValues[4].textContent = `${size} sq. miles`;
                statValues[5].textContent = `${elevation} ft`;
                statValues[6].textContent = climate.type;
                statValues[7].textContent = terrain;
                statValues[8].textContent = government.type;
                statValues[9].textContent = leaderTitle;
                statValues[10].textContent = stability;
                statValues[11].textContent = corruption;
                statValues[12].textContent = economy.status;
                statValues[13].textContent = currencyType;
                statValues[14].textContent = tradeStatus;
                statValues[15].textContent = `${taxRate}% of income`;
                statValues[16].textContent = `${literacyRate}%`;
                statValues[17].textContent = crimeRate;
                statValues[18].textContent = punishmentSeverity;
                statValues[19].textContent = wallHeight;
                statValues[20].textContent = architecture.style;
                statValues[21].textContent = streetType;
                statValues[22].textContent = sewerSystem;
                statValues[23].textContent = `${foundingYears} years ago`;
                statValues[24].textContent = foundingRace;
            }
            document.querySelector('#government-details').innerHTML = governmentDetailsHTML;
            document.querySelector('#industries-list').innerHTML = industriesHTML;
            document.querySelector('#languages-list').innerHTML = languagesHTML;
            document.querySelector('#crime-details').innerHTML = crimeDetailsHTML;
            document.querySelector('#religions-list').innerHTML = religionsHTML;
            document.querySelector('#holy-sites').innerHTML = holySitesHTML;
            document.querySelector('#notable-structures').innerHTML = structuresHTML;
            document.querySelector('#districts-list').innerHTML = districtsHTML;
            document.querySelector('#historical-events').innerHTML = historicalEventsHTML;
            document.querySelector('#legends').innerHTML = legendsHTML;
            generateFlag();
        }
        
        // Toggle section expansion
        function toggleSection(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
        }
        
        // Initial generation and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Generate initial city
            generateCity();
            
            // Explicitly add event listener to generate button
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn) {
                generateBtn.onclick = function() {
                    generateCity();
                };
            }
            
            // Expand all sections by default
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('expanded');
            });
        });
        
        // Backup onload handler in case DOMContentLoaded was missed
        window.onload = function() {
            const generateBtn = document.getElementById('generate-btn');
            if (generateBtn && !generateBtn.onclick) {
                generateBtn.onclick = function() {
                    generateCity();
                };
            }
        };
    </script>
</body>
</html>
